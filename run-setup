#!/bin/bash
set -e -o pipefail

while :; do
	_hostname="$(hostname -f)"
	if [[ $_hostname == *.* && $_hostname != *.internal ]]; then
		break
	fi
	systemctl restart systemd-networkd
	echo "Waiting for FQDN..."
	sleep 10
done

apt install -y --no-install-recommends \
    apt-transport-https gnupg2 \
    collectd liboping0 jq dnsutils \
	bpfcc-tools iotop libjemalloc2 \
	openjdk-11-jdk-headless \
	nginx libnginx-mod-http-fancyindex \
	coreutils tree \
	python3 python3-venv build-essential

curl -sSfL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
echo 'deb [arch=amd64] https://download.docker.com/linux/ubuntu cosmic stable' \
    >/etc/apt/sources.list.d/docker-ce.list

curl -sSfL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
echo "deb http://packages.cloud.google.com/apt gcsfuse-bionic main" \
	>/etc/apt/sources.list.d/gcsfuse.list

apt update
apt install -y --no-install-recommends docker-ce gcsfuse

install -C -m644 collectd.conf -t /etc/collectd/
systemctl restart collectd

mkdir -p /opt/rdoctor
curl -fsSL -z /opt/rdoctor/rdoctor -o /opt/rdoctor/rdoctor \
	https://build.rchain-dev.tk/misc/rdoctor/latest/linux.amd64/rdoctor
chmod +x /opt/rdoctor/rdoctor

if ! grep -Fq rundeck /root/.ssh/authorized_keys; then
	mkdir -p -m700 /root/.ssh
	cat rundeck-id_rsa.pub >>/root/.ssh/authorized_keys
fi

mkdir -p /var/lib/rnode-static
chmod 710 /var/lib/rnode-static
chgrp www-data /var/lib/rnode-static

mkdir -p /var/lib/rnode-diag
chmod 750 /var/lib/rnode-diag
chgrp www-data /var/lib/rnode-diag

files_dir="node-files${PROFILE:+.$PROFILE}"
cp -u $files_dir/$(hostname).*/* /var/lib/rnode-static/
cp -u logback.xml $files_dir/validator-public-keys.txt /var/lib/rnode-static/

if [[ -z "$(docker ps -q -f name='^logspout$')" ]]; then
	docker rm logspout || true
	docker pull gliderlabs/logspout
	docker run -d --restart=unless-stopped --name=logspout \
		-p 8181:80 -v /var/run/docker.sock:/var/run/docker.sock \
		gliderlabs/logspout
fi

if ! getent passwd javadebug >/dev/null; then
	useradd -rM -s /bin/false -d /home/javadebug javadebug
	install -m700 -o javadebug -d /home/javadebug
	install -m700 -o javadebug -d /home/javadebug/.ssh
fi
install -C -o javadebug authorized_keys.javadebug /home/javadebug/.ssh/authorized_keys

install -C sshd_config -t /etc/ssh/
systemctl reload sshd

install -C -m644 nginx/* -t /etc/nginx/
systemctl reload nginx

mkdir -p /mnt/heapdumps

install -C -m644 *.service *.timer *.mount -t /usr/lib/systemd/system/
systemctl daemon-reload

systemctl enable --now mnt-heapdumps.mount sync-diag.timer
systemctl enable --now autopropose.service || true # ignore if masked

pushd scripts
python3 -mvenv venv
source ./venv/bin/activate
pip3 -q install -r requirements.txt
popd
