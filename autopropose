#!/bin/bash
set -e -o pipefail

delay_min=60
delay_max=90
interval=$((delay_min + (delay_max - delay_min)/2))

propose_exe="$(dirname $0)/rundeck-scripts/propose"
env_file=/var/lib/rnode-static/local.autopropose.env

while :; do
	while [[ -z "$(docker ps -q -f name='^rnode$')" ]]; do
		sleep 15
	done

	sleep "$(shuf -n1 -i$delay_min-$delay_max)"

	if [[ -e $env_file ]]; then
		source $env_file || ret=$?
		if (( $ret )); then
			echo "$env_file returned error code $ret" >&2
		fi
	fi

	propose_start=$(date +%s)
	$propose_exe || ret=$?
	propose_end=$(date +%s)

	propose_duration=$((propose_end - propose_start))
	collectdctl putval \
		$(hostname -f)/rnode/duration-propose \
		interval=$interval \
		$propose_start:$propose_duration

	if (( $ret )); then
		echo "Propose exited with error code $ret" >&2
	fi
done
