#!/bin/bash
#
apt update
apt -y upgrade 
apt -y install docker.io collectd certbot

mkfs.ext4 -m 0 -E lazy_itable_init=0,lazy_journal_init=0,discard /dev/xvdc
mkdir -p /rchain/rnode /rchain/rnode-static /rchain/rnode-diag
mount -o discard,defaults /dev/xvdc /rchain
echo "UUID=`blkid|grep \"^/dev/xvdc\"|cut -d'\"' -f2` /rchain ext4 discard,defaults,nofail 0 2" >>/etc/fstab
ln -s /rchain/rnode /var/lib/rnode
ln -s /rchain/rnode-static /var/lib/rnode-static
ln -s /rchain/rnode-diag /var/lib/rnode-diag

curl -o /etc/collectd/collectd.conf  https://raw.githubusercontent.com/rchain/rchain-testnet-node/dev/collectd.conf
curl -o /var/lib/rnode-static/logback.xml https://raw.githubusercontent.com/rchain/rchain-testnet-node/dev/logback.xml

create-user() {
        adduser --disabled-password --gecos '' $3
        mkdir -p /home/$3/.ssh
        echo "$*" > /home/$3/.ssh/authorized_keys
        chown -R $3:$3 /home/$3/.ssh
        chmod 700 /home/$3/.ssh
        chmod 600 /home/$3/.ssh/authorized_keys
        usermod -aG sudo $3
}
create-user ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDWkvhCO9cuEIZIl5Hmmtq0Lbr3S7PB0XXhsV/iBDIwShs8kO55Klc2VP+Quva+jNjjuwg5KrlIUrcaYCp39XQGR/3f1YlwnR4HFdRbvppxCCqDjtzWw/ly1BfIljswjRRbom1qGV9A+paecU1gOjQ3hRdxGbY9AIATOfUsjy4IB1/RpwCAe8is1ZEoAWeT2QWY7aTVEjgyxy6+aUh1awDngeUEXfPmvD3FQ+c79stEN1EYf/uGKg/KADyCLNIE0k6Avte23hwtSADK01fGU5aehiKGLPBc+gdLvlycGUuogCFrsTKvs63ocE0Upt0iBy6YkUTOcjIg2ZyPQZzECHJp test-ibm
