a#!/bin/bash
#
apt update
apt -y upgrade 
apt -y install docker.io collectd certbot

mkfs.ext4 -m 0 -E lazy_itable_init=0,lazy_journal_init=0,discard /dev/xvdc
mkdir -p /rchain/rnode /rchain/rnode-static /rchain/rnode-diag
mount -o discard,defaults /dev/xvdc /rchain
echo "UUID=`blkid|grep \"^/dev/xvdc\"|cut -d'\"' -f2` /rchain ext4 discard,defaults,nofail 0 2" >>/etc/fstab
ln -s /rchain/rnode /var/lib/rnode
ln -s /rchain/rnode-static /var/lib/rnode-static
ln -s /rchain/rnode-diag /var/lib/rnode-diag

curl -o /etc/collectd/collectd.conf  https://raw.githubusercontent.com/rchain/rchain-testnet-node/dev/collectd.conf
curl -o /var/lib/rnode-static/logback.xml https://raw.githubusercontent.com/rchain/rchain-testnet-node/dev/logback.xml

curl https://raw.githubusercontent.com/rchain/rchain-testnet-node/dev/rundeck-scripts/provision_nginx_proxy.sh | bash 

create-user() {
        adduser --disabled-password --gecos '' $1
        mkdir -p /home/$1/.ssh
        echo "ssh-rsa $2 $1" > /home/$1/.ssh/authorized_keys
        chown -R $1:$1 /home/$1/.ssh
        chmod 700 /home/$1/.ssh
        chmod 600 /home/$1/.ssh/authorized_keys
        usermod -aG sudo $1
}
create-user gsj "AAAAB3NzaC1yc2EAAAABJQAAAQEAt9RH/gOVhBcfK5kDK3IYhKu5+JDwS9n86iFywEjFd6bwRs99xJC5iVk8GY23tojI5TCWshTz0f6dPIJV6jdneeGbVsFgKzKrKF9EXfWd5fZwArhSZQ2++A0nwg6duKci3qPbtBX0SlV1fBS/8tpYklsKLkjW6+63Qc0KYBsRjSm4Nr3MDtTSc8bqIS8LXJZVEkjwoi0BenTYaveEAITU0ZLwCysJmx65NRpDYAq1yx2qjYB8woFxSqJMgqoqpGMQ67UP35DHB5B3IuYSpI2GnHkBF5zwpeGwk8/Jwaoi7qe3uwuc7MXaqsgOjjm5nsklbHbVX+Lw0x9uljvYsd5n/Q=="

